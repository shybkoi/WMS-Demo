(function($){function init(plot){var canvas=null;var target=null;var data=null;var maxRadius=null;var centerLeft=null;var centerTop=null;var slices=[];var total=0;var redraw=true;var redrawAttempts=10;var shrink=0.95;var legendWidth=0;plot.hooks.processOptions.push(checkPieEnabled);function checkPieEnabled(plot,options){if(options.series.pie.show){options.grid.borderWidth=0;if(options.series.pie.label.show=='auto')if(options.legend.show&&plot.insertLegend&&plot.setSeries)options.series.pie.label.show=false;else options.series.pie.label.show=true;if(options.series.pie.radius=='auto')if(options.series.pie.label.show)options.series.pie.radius=3/4;else options.series.pie.radius=1;plot.hooks.processDatapoints.push(hijack);plot.hooks.bindEvents.push(bindEvents)}}function alertObject(obj){var msg='';function traverse(obj,depth){if(!depth)depth=0;for(var i in obj){for(var j=0;j<depth;j++)msg+='\t';if(typeof obj[i]=="object"){msg+=''+i+':\n';traverse(obj[i],depth+1)}else{msg+=''+i+': '+obj[i]+'\n'}}}traverse(obj);alert(msg)}function calcTotal(data){for(var i in data)total+=data[i].data}function hijack(plot,series,data,datapoints){canvas=plot.getCanvas();target=$(canvas).parent();data=plot.getData();options=plot.getOptions();if(plot.insertLegend&&!options.legend.container){plot.insertLegend();legendWidth=target.children().filter('.legend').children().width()}plot.setData([]);maxRadius=Math.min(canvas.width,canvas.height)/2;centerTop=(canvas.height/2)+options.series.pie.offset.top;centerLeft=(canvas.width/2);if(options.series.pie.offset.left)if(options.legend.position.match('w'))centerLeft+=legendWidth;else centerLeft-=legendWidth;else centerLeft+=options.series.pie.offset.top;if(centerLeft<maxRadius)centerLeft=maxRadius;else if(centerLeft>canvas.width-maxRadius)centerLeft=canvas.width-maxRadius;createSlices(data)}function parseData(data){var newdata=[];for(var i in data){newdata.push({label:data[i].label,data:data[i].data})}return newdata}function createSlices(data){calcTotal(data);var combined=0;var color=options.series.pie.combine.color;for(var i in data){if(data[i].data/total<=options.series.pie.combine.threshold){combined+=data[i].data;if(!color)color=data[i].color}else{slices.push({value:data[i].data,color:data[i].color,label:data[i].label,angle:(data[i].data*(Math.PI*2))/total,percent:(data[i].data/total*100)})}}if(combined>0)slices.push({value:combined,color:color,label:options.series.pie.combine.label,angle:(combined*(Math.PI*2))/total,percent:(combined/total*100)})}function bindEvents(plot,eventHolder){draw()}function draw(){var attempts=0;while(redraw&&attempts<redrawAttempts){redraw=false;if(attempts>0)maxRadius*=shrink;attempts+=1;clear();drawPie()}if(attempts>=redrawAttempts){clear();target.prepend('<div class="error">Could not draw pie with labels contained inside canvas</div>')}if(plot.setSeries&&plot.insertLegend){plot.setSeries(slices);plot.insertLegend()}function clear(){ctx=canvas.getContext("2d");ctx.clearRect(0,0,canvas.width,canvas.height);target.children().filter('.pieLabel, .pieLabelBackground').remove()}function drawPie(){ctx=canvas.getContext("2d");startAngle=Math.PI*options.series.pie.startAngle;if(options.series.pie.radius>1)var radius=options.series.pie.radius;else var radius=maxRadius*options.series.pie.radius;ctx.save();ctx.translate(centerLeft,centerTop);ctx.save();var currentAngle=startAngle;for(var i in slices)drawSlice(slices[i].angle,slices[i].color,true);ctx.restore();ctx.save();ctx.lineWidth=options.series.pie.stroke.width;currentAngle=startAngle;for(var i in slices)drawSlice(slices[i].angle,options.series.pie.stroke.color,false);ctx.restore();if(options.series.pie.label.show)drawLabels();ctx.restore();function drawSlice(angle,color,fill){if(fill)ctx.fillStyle=color;else ctx.strokeStyle=color;ctx.beginPath();if(angle!=Math.PI*2)ctx.moveTo(0,0);ctx.arc(0,0,radius,currentAngle,currentAngle+angle,false);ctx.closePath();currentAngle+=angle;if(fill)ctx.fill();else ctx.stroke()}function drawLabels(){var currentAngle=startAngle;if(options.series.pie.label.radius>1)var radius=options.series.pie.label.radius;else var radius=maxRadius*options.series.pie.label.radius;for(var i in slices){if(slices[i].percent>=options.series.pie.label.threshold*100)drawLabel(slices[i],currentAngle,i);currentAngle+=slices[i].angle}function drawLabel(slice,startAngle,index){var lf=options.legend.labelFormatter,text,plf=options.series.pie.label.formatter;if(lf)text=lf(slice.label,slice);else text=slice.label;if(plf)text=plf(text,slice);var halfAngle=((startAngle+slice.angle)+startAngle)/2;var x=centerLeft+Math.round(Math.cos(halfAngle)*radius);var y=centerTop+Math.round(Math.sin(halfAngle)*radius);var html='<span class="pieLabel" id="pieLabel'+index+'" style="position:absolute;top:'+y+'px;left:'+x+'px;">'+text+"</span>";target.append(html);var label=target.children('#pieLabel'+index);var labelTop=(y-label.height()/2);var labelLeft=(x-label.width()/2);label.css('top',labelTop);label.css('left',labelLeft);if(0-labelTop>0||0-labelLeft>0||canvas.height-(labelTop+label.height())<0||canvas.width-(labelLeft+label.width())<0)redraw=true;if(options.series.pie.label.background.opacity!=0){var c=options.series.pie.label.background.color;if(c==null){c=slice.color}var pos='top:'+labelTop+'px;left:'+labelLeft+'px;';$('<div class="pieLabelBackground" style="position:absolute;width:'+label.width()+'px;height:'+label.height()+'px;'+pos+'background-color:'+c+';"> </div>').insertBefore(label).css('opacity',options.series.pie.label.background.opacity)}}}}}function insertLegend(){target.find(".legend").remove();series=slices;if(!options.legend.show)return;var fragments=[],rowStarted=false,lf=options.legend.labelFormatter,s,label;for(i=0;i<series.length;++i){s=series[i];label=s.label;if(!label)continue;if(i%options.legend.noColumns==0){if(rowStarted)fragments.push('</tr>');fragments.push('<tr>');rowStarted=true}if(lf)label=lf(label,s);fragments.push('<td class="legendColorBox"><div style="border:1px solid '+options.legend.labelBoxBorderColor+';padding:1px"><div style="width:4px;height:0;border:5px solid '+s.color+';overflow:hidden"></div></div></td>'+'<td class="legendLabel">'+label+'</td>')}if(rowStarted)fragments.push('</tr>');if(fragments.length==0)return;var table='<table style="font-size:smaller;color:'+options.grid.color+'">'+fragments.join("")+'</table>';if(options.legend.container!=null)$(options.legend.container).html(table);else{var pos="",p=options.legend.position,m=options.legend.margin;if(m[0]==null)m=[m,m];if(p.charAt(0)=="n")pos+='top:'+(m[1]+plotOffset.top)+'px;';else if(p.charAt(0)=="s")pos+='bottom:'+(m[1]+plotOffset.bottom)+'px;';if(p.charAt(1)=="e")pos+='right:'+(m[0]+plotOffset.right)+'px;';else if(p.charAt(1)=="w")pos+='left:'+(m[0]+plotOffset.left)+'px;';var legend=$('<div class="legend">'+table.replace('style="','style="position:absolute;'+pos+';')+'</div>').appendTo(target);if(options.legend.backgroundOpacity!=0.0){var c=options.legend.backgroundColor;if(c==null){var tmp;if(options.grid.backgroundColor&&typeof options.grid.backgroundColor=="string")tmp=options.grid.backgroundColor;else tmp=plot.extractColor(legend);c=plot.parseColor(tmp).adjust(null,null,null,1).toString()}var div=legend.children();$('<div style="position:absolute;width:'+div.width()+'px;height:'+div.height()+'px;'+pos+'background-color:'+c+';"> </div>').prependTo(legend).css('opacity',options.legend.backgroundOpacity)}}}}var options={series:{pie:{show:false,radius:'auto',startAngle:3/2,offset:{top:0,left:'auto'},stroke:{color:'#FFF',width:1},label:{show:'auto',formatter:function(label,slice){return'<div style="font-size:x-small;text-align:center;padding:2px;color:'+slice.color+';">'+label+'<br/>'+Math.round(slice.percent)+'%</div>'},radius:1,background:{color:null,opacity:0},threshold:0},combine:{threshold:0,color:null,label:'Other'}}}};$.plot.plugins.push({init:init,options:options,name:"pie",version:"0.2"})})(jQuery);