function kTblScroll(tableEl, tableHeight, tableWidth, options) {
    options = options || {};

	this.getSize = function(size) { 
        if ((''+size).indexOf('%')>0) return (size ? parseInt(size) : 0)+'%';
        else return (size ? parseInt(size) : 0)+'px';
    }
    
    // Скроллинг для Chrome/Opera (вместе с thead/tfooter)
    this.initSafariengine = function () {
        if (this.tableEl.parentElement && this.tableEl.parentElement.className.indexOf("kTblScrollSafari")!=-1) 
        {   this.containerEl = this.tableEl.parentElement;}
        else
        {   this.containerEl = this.tableEl.parentNode.insertBefore(document.createElement('div'), this.tableEl);
            this.containerEl.appendChild(this.tableEl);
            this.tableEl.parentElement.className = this.tableEl.parentElement.className+" kTblScrollSafari";
        }
        this.containerEl.style.height = this.newHeight + 'px';
        this.containerEl.style.width = this.newWidth == 'auto' ? (this.tableEl.clientWidth + 1)+ 'px' : this.newWidth;

        this.containerEl.style.overflowY = 'auto';
		if (this.tableEl.parentElement.clientHeight < this.tableEl.offsetHeight) {
            if ((''+this.newWidth).indexOf('px')>0) this.tableEl.style.width = parseInt(this.newWidth) - this.scrollWidth +'px';
            else this.tableEl.style.width = this.tableEl.parentElement.offsetWidth - this.scrollWidth +'px';
		} else {
            this.containerEl.style.overflowY = 'auto';
			this.tableEl.style.width = this.newWidth;
		}
	};
	
    // Скроллинг для IE
    this.initIEengine = function () {
        if (this.tableEl.parentElement && this.tableEl.parentElement.className.indexOf("kTblScrollIE")!=-1) 
        {   this.containerEl = this.tableEl.parentElement;}
        else
        {   
            this.containerEl = this.tableEl.parentNode.insertBefore(document.createElement('div'), this.tableEl);
            this.containerEl.appendChild(this.tableEl);
            this.tableEl.parentElement.className = this.tableEl.parentElement.className+" kTblScrollIE";
        }
        this.containerEl.style.height = this.newHeight + 'px';
        this.containerEl.style.width = this.newWidth == 'auto' ? (this.tableEl.clientWidth + 1)+ 'px' : this.newWidth;

        this.containerEl.style.overflowY = 'auto';    
        if (this.tableEl.parentElement.clientHeight < this.tableEl.offsetHeight) {
            if ((''+this.newWidth).indexOf('px')>0) this.tableEl.style.width = parseInt(this.newWidth) - this.scrollWidth +'px';
            else if (this.tableEl.parentElement.offsetWidth - this.scrollWidth > 0)
                    this.tableEl.style.width = this.tableEl.parentElement.offsetWidth - this.scrollWidth +'px';
        } else {
            this.containerEl.style.overflowY = 'auto';
            this.tableEl.style.width = this.newWidth;
        }

        if (this.thead) {
            var trs = this.thead.getElementsByTagName('tr');
            for (x=0; x<trs.length; x++) {
                trs[x].style.position ='relative';
                trs[x].style.setExpression("top",  "this.parentElement.parentElement.parentElement.scrollTop + 'px'");
            }
        }
        if (this.tfoot) {
            var trs = this.tfoot.getElementsByTagName('tr');
            for (x=0; x<trs.length; x++) {
                trs[x].style.position ='relative';
                trs[x].style.setExpression("bottom",  "(this.parentElement.parentElement.offsetHeight - this.parentElement.parentElement.parentElement.clientHeight - this.parentElement.parentElement.parentElement.scrollTop) + 'px'");
            }
        }
        
        if (!this.tableEl.id) {
            this.tableEl.id = 'id' + Math.floor(Math.random()*1000);
        }
        //Здесь IE6 падал
        //eval("window.attachEvent('onresize', function () { document.getElementById('" + this.tableEl.id + "').style.visibility = 'hidden'; document.getElementById('" + this.tableEl.id + "').style.visibility = 'visible'; } );");
        $(window).resize(function() {
            if ($(this.tableEl).is(':visible'))
                $(this.tableEl).css('visibility', 'hidden').css('visibility', 'visible');
        });
    };

    // Скроллинг под FireFox
    this.initFFengine = function () {
        this.tbody.style.overflow = '-moz-scrollbars-none';
        this.tbody.style.height = "auto";
        this.tableEl.style.borderCollapse = 'separate';
        
        var headHeight = (this.thead) ? this.thead.clientHeight : 0;
        var footHeight = (this.tfoot) ? this.tfoot.clientHeight : 0;
        var bodyHeight = this.tbody.clientHeight;
        var trs = this.tbody.getElementsByTagName('tr');
        
        
        if (this.tableEl.clientHeight >= this.newHeight) {
            this.tbody.style.overflow = '-moz-scrollbars-vertical';
            
            var needPadding = options.needPadding ? true : false;
            if (this.thead) {
                var headTrs = this.thead.getElementsByTagName('tr');
                for (var x=0; x<headTrs.length; x++) {
                    var tds = headTrs[x].getElementsByTagName('th');
                    if (!tds.length) {
                        var tds = headTrs[x].getElementsByTagName('td');
                    }
                    if (tds.length) {
                        var lastTd = tds[tds.length-1];
                        
                        var currPadding = parseInt(lastTd.style.paddingRight);
                        if (!currPadding) currPadding = 0;
                        
                        if (currPadding<this.scrollWidth) {
                            lastTd.style.paddingRight = currPadding + this.scrollWidth + 'px';
                            needPadding = true;
                        }
                    }
                }
            }

            if (needPadding)
                for (var x=0; x<trs.length; x++) {
                    var tds = trs[x].getElementsByTagName('td');
                    if (tds.length==0)
                        tds = trs[x].getElementsByTagName('th');
                    if (tds.length) {
                        var lastTd = tds[tds.length-1];
                        
                        lastTd.style.paddingRight += this.scrollWidth + 'px';
                        var currPadding = parseInt(lastTd.style.paddingRight);
                        if (!currPadding) currPadding = 0;
                        
                        if (currPadding<this.scrollWidth) {
                            lastTd.style.paddingRight = currPadding + this.scrollWidth + 'px';
                            needPadding = true;
                        }
                    }
                }

            var cellSpacing = (this.tableEl.offsetHeight - (this.tbody.clientHeight + headHeight + footHeight)) / 4;
            this.tbody.style.height = (this.newHeight - (headHeight + cellSpacing * 2) - (footHeight + cellSpacing * 2)) + 'px';
            
        } else if (options.allwaysFullHeight) {
            if ($(this.tableEl).next() && !$(this.tableEl).next().hasClass("kTblScrollFFdiv")) {   
                $(this.tableEl).after('<div class="kTblScrollFFdiv" style="width: ' + this.newWidth + '; height: ' + (this.newHeight-this.tableEl.offsetHeight) + 'px; margin: 0;"/>');
            } else {
                $(this.tableEl).next().css({width: this.newWidth, height: (this.newHeight-this.tableEl.offsetHeight)});
            }
        }
        this.tableEl.style.width = this.newWidth;
    };

    // Предподготовка
    this.tableEl = tableEl;
    
	var thead = this.tableEl.getElementsByTagName('thead');
	this.thead = (thead[0]) ? thead[0] : null;

	var tfoot = this.tableEl.getElementsByTagName('tfoot');
	this.tfoot = (tfoot[0]) ? tfoot[0] : null;

	var tbody = this.tableEl.getElementsByTagName('tbody');
	this.tbody = (tbody[0]) ? tbody[0] : null;

	if (!this.tbody) return;

	this.scrollWidth = 17;

	this.newHeight = parseInt(tableHeight);
	this.newWidth = tableWidth == 'auto' ? 'auto' : tableWidth ? this.getSize(tableWidth) : this.tableEl.clientWidth;
    this.tableEl.style.height = 'auto';
	this.tableEl.removeAttribute('height');

    //if (document.all && document.getElementById && !window.opera) this.initIEengine();
    //if (!document.all && document.getElementById && !window.opera) this.initFFengine();
    if ($.browser.msie)
        this.initIEengine();
    else if ($.browser.safari || $.browser.opera)
        this.initSafariengine();
    else if ($.browser.mozilla)
        this.initFFengine();
}

jQuery.fn.Scrollable = function(tableHeight, tableWidth, options) {
	return this.each(function(){
        //if (jQuery.browser.msie || jQuery.browser.mozilla || !jQuery.browser.name) {
            //var table = new kTblScroll(this, tableHeight, tableWidth);
            return kTblScroll(this, tableHeight, tableWidth, options);
		//}
	});
};

jQuery.fn.kScrollToTr = function()
{   var $tr = $(this);
    var offsetTr = $tr.offset();
    var offsetTBody = $tr.parents("tbody").offset();
    var scrollTop = parseInt($tr.parents("tbody")[0].scrollTop);
    if (!scrollTop) scrollTop = 0;
    $tr.parents("tbody")[0].scrollTop = scrollTop + offsetTr.top-offsetTBody.top;
    $tr.kScrollDrawTr();
    return $tr;
}

jQuery.fn.kScrollDrawTr = function()
{   var $tr = $(this);
    if (!document.all && document.getElementById && !window.opera)
    {   if ($tr.parents("tbody").css("overflow-y") == 'scroll')
        {   var curPadding = parseInt($tr.find("td:last").get(0).style.paddingRight);
            if (!curPadding) curPadding = 0;
            if (curPadding<17) $tr.find("td:last").get(0).style.paddingRight = ''+(curPadding+17)+'px';
        }
    }
    return $tr;
}

jQuery.fn.kTblScroll = function(options)
{   if (options){
        if (typeof options=='object')
            width = options.width ? options.width : '100%';
        else width = options;
    }
    else width = '100%';
    
    return this.each(function(){
            var tbl = $(this);
            if (tbl.length!=0)
            {   var parent = tbl.parent();
                var Offset = tbl.offset();
                var parentOffset = parent.offset();
                var remh = parent.height() - (Offset.top-parentOffset.top);
                tbl.Scrollable(remh, width, options); 
            }
        });
}