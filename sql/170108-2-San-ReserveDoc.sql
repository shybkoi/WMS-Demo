/******************************************************************************/
/***               Generated by IBExpert 09.01.2017 21:57:39                ***/
/******************************************************************************/

/******************************************************************************/
/***      Following SET SQL DIALECT is just for the Database Comparer       ***/
/******************************************************************************/
SET SQL DIALECT 3;



/******************************************************************************/
/***                                 Tables                                 ***/
/******************************************************************************/


CREATE GENERATOR GEN_WH_RESERVE_DOC_ID;

CREATE TABLE WH_RESERVE_DOC (
    RESERVEID  R_ID NOT NULL /* R_ID = INTEGER */,
    AMOUNT     R_DOUBLE NOT NULL /* R_DOUBLE = DOUBLE PRECISION */,
    ID         R_ID NOT NULL /* R_ID = INTEGER */,
    DOCID      R_ID64 NOT NULL /* R_ID = INTEGER */
);




/******************************************************************************/
/***                              Primary Keys                              ***/
/******************************************************************************/

ALTER TABLE WH_RESERVE_DOC ADD CONSTRAINT PK_WH_RESERVE_DOC PRIMARY KEY (ID);


/******************************************************************************/
/***                              Foreign Keys                              ***/
/******************************************************************************/

ALTER TABLE WH_RESERVE_DOC ADD CONSTRAINT FK_WH_RESERVE_DOC_DID FOREIGN KEY (DOCID) REFERENCES DOCUMENT (DOCID) ON DELETE CASCADE ON UPDATE CASCADE;
ALTER TABLE WH_RESERVE_DOC ADD CONSTRAINT FK_WH_RESERVE_DOC_RID FOREIGN KEY (RESERVEID) REFERENCES WH_RESERVE (ID);


/******************************************************************************/
/***                                Triggers                                ***/
/******************************************************************************/


SET TERM ^ ;



/******************************************************************************/
/***                          Triggers for tables                           ***/
/******************************************************************************/



/* Trigger: WH_RESERVE_CLIENT_AD0 */
CREATE OR ALTER TRIGGER WH_RESERVE_DOC_AD0 FOR WH_RESERVE_DOC
ACTIVE AFTER DELETE POSITION 0
AS
begin
    update wh_reserve r
       set r.amountdoc = r.amountdoc - old.amount
     where r.id = old.reserveid;
end
^


/* Trigger: WH_RESERVE_CLIENT_AI0 */
CREATE OR ALTER TRIGGER WH_RESERVE_DOC_AI0 FOR WH_RESERVE_DOC
ACTIVE AFTER INSERT POSITION 0
AS
begin
    update wh_reserve r
       set r.amountdoc = r.amountdoc + new.amount
     where r.id = new.reserveid;
end
^


/* Trigger: WH_RESERVE_CLIENT_AU0 */
CREATE OR ALTER TRIGGER WH_RESERVE_DOC_AU0 FOR WH_RESERVE_DOC
ACTIVE AFTER UPDATE POSITION 0
AS
begin
    if (old.reserveid = new.reserveid) then
    begin
        update wh_reserve r
           set r.amountdoc = r.amountdoc - old.amount + new.amount
         where r.id = new.reserveid;
    end
    else
    begin
        update wh_reserve r
           set r.amountdoc = r.amountdoc - old.amount
         where r.id = old.reserveid;

        update wh_reserve r
           set r.amountdoc = r.amountdoc + new.amount
         where r.id = new.reserveid;
    end

    if (new.amount < 0.0000001) then
        delete from wh_reserve_doc rc
         where rc.id = new.id;
end
^


/* Trigger: WH_RESERVE_CLIENT_BI */
CREATE OR ALTER TRIGGER WH_RESERVE_DOC_BI FOR WH_RESERVE_DOC
ACTIVE BEFORE INSERT POSITION 0
as
begin
  if (new.amount < 0.000001) then
    exception exc_wh_reserve 'Резерв должен быть положительным числом!';

  if (new.id is null) then
    new.id = gen_id(gen_wh_reserve_doc_id,1);
end
^


/* Trigger: WH_RESERVE_CLIENT_BU0 */
CREATE OR ALTER TRIGGER WH_RESERVE_DOC_BU0 FOR WH_RESERVE_DOC
ACTIVE BEFORE UPDATE POSITION 0
AS
begin
  if (new.amount < -0.000001) then
    exception exc_wh_reserve 'Резерв должен быть положительным числом!';
end
^


SET TERM ; ^

